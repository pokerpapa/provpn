name: Sync README from upstream (rewrite links)

on:
  schedule:
    - cron: '15 */2 * * *'   # ÐºÐ°Ð¶Ð´Ñ‹Ðµ 2 Ñ‡Ð°ÑÐ°, +15 Ð¼Ð¸Ð½ Ð¿Ð¾ÑÐ»Ðµ txt
  workflow_dispatch:

jobs:
  sync-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Download upstream README
        run: |
          curl -fsSL \
            https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/main/README.md \
            -o README.upstream.md

      - name: Rewrite links for this repo
        run: |
          sed \
            -e 's|raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main|raw.githubusercontent.com/pokerpapa/provpn/main|g' \
            -e 's|raw.githubusercontent.com/igareck/vpn-configs-for-russia/main|raw.githubusercontent.com/pokerpapa/provpn/main|g' \
            -e 's|github.com/igareck/vpn-configs-for-russia|github.com/pokerpapa/provpn|g' \
            README.upstream.md > README.tmp.md

      - name: Inject mirror notice
        run: |
          MIRROR_BLOCK='> ðŸ”„ **Ð­Ñ‚Ð¾ Ð·ÐµÑ€ÐºÐ°Ð»Ð¾ (auto-sync) Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°**  \n> ÐžÑ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: https://github.com/igareck/vpn-configs-for-russia  \n>  \n> TXT-Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¸ README Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 2 Ñ‡Ð°ÑÐ°.\n\n'

          if ! grep -q "Ð­Ñ‚Ð¾ Ð·ÐµÑ€ÐºÐ°Ð»Ð¾ (auto-sync)" README.tmp.md; then
            awk -v block="$MIRROR_BLOCK" '
              NR==1 { print block }
              { print }
            ' README.tmp.md > README.md
          else
            mv README.tmp.md README.md
          fi

          rm -f README.upstream.md README.tmp.md

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep .; then
            git add README.md
            git commit -m "sync(readme): update README from upstream with rewritten links"
            git push
          else
            echo "README is up to date"
          fi
